<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>[Python Essentials] Mental Models of Expert Level Features | Learning Automata</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="[Python Essentials] Mental Models of Expert Level Features" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Stepping up Python skills" />
<meta property="og:description" content="Stepping up Python skills" />
<link rel="canonical" href="http://blog.logancyang.com/note/python/2020/06/15/python-metaclasses.html" />
<meta property="og:url" content="http://blog.logancyang.com/note/python/2020/06/15/python-metaclasses.html" />
<meta property="og:site_name" content="Learning Automata" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-15T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Stepping up Python skills","@type":"BlogPosting","headline":"[Python Essentials] Mental Models of Expert Level Features","dateModified":"2020-06-15T00:00:00-05:00","datePublished":"2020-06-15T00:00:00-05:00","url":"http://blog.logancyang.com/note/python/2020/06/15/python-metaclasses.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://blog.logancyang.com/note/python/2020/06/15/python-metaclasses.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://blog.logancyang.com/feed.xml" title="Learning Automata" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-164976898-2','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>[Python Essentials] Mental Models of Expert Level Features | Learning Automata</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="[Python Essentials] Mental Models of Expert Level Features" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Stepping up Python skills" />
<meta property="og:description" content="Stepping up Python skills" />
<link rel="canonical" href="http://blog.logancyang.com/note/python/2020/06/15/python-metaclasses.html" />
<meta property="og:url" content="http://blog.logancyang.com/note/python/2020/06/15/python-metaclasses.html" />
<meta property="og:site_name" content="Learning Automata" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-06-15T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Stepping up Python skills","@type":"BlogPosting","headline":"[Python Essentials] Mental Models of Expert Level Features","dateModified":"2020-06-15T00:00:00-05:00","datePublished":"2020-06-15T00:00:00-05:00","url":"http://blog.logancyang.com/note/python/2020/06/15/python-metaclasses.html","mainEntityOfPage":{"@type":"WebPage","@id":"http://blog.logancyang.com/note/python/2020/06/15/python-metaclasses.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="http://blog.logancyang.com/feed.xml" title="Learning Automata" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-164976898-2','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Learning Automata</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[Python Essentials] Mental Models of Expert Level Features</h1><p class="page-description">Stepping up Python skills</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-06-15T00:00:00-05:00" itemprop="datePublished">
        Jun 15, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      8 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#note">note</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#python">python</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#metaclass-problem">Metaclass: problem</a></li>
<li class="toc-entry toc-h2"><a href="#metaclass-solution">Metaclass: solution</a></li>
<li class="toc-entry toc-h2"><a href="#decorators">Decorators</a>
<ul>
<li class="toc-entry toc-h3"><a href="#functoolswraps">functools.wraps</a></li>
<li class="toc-entry toc-h3"><a href="#decorator-with-parameters-the-partial-trick">Decorator with parameters: the partial trick</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#generators-two-mental-models">Generators: two mental models</a>
<ul>
<li class="toc-entry toc-h3"><a href="#laziness">Laziness</a></li>
<li class="toc-entry toc-h3"><a href="#sequencing">Sequencing</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#context-managers">Context managers</a></li>
<li class="toc-entry toc-h2"><a href="#summary">Summary</a></li>
<li class="toc-entry toc-h2"><a href="#reference">Reference</a></li>
</ul><h2 id="metaclass-problem">
<a class="anchor" href="#metaclass-problem" aria-hidden="true"><span class="octicon octicon-link"></span></a>Metaclass: problem</h2>

<p>Suppose there is an infra team that writes library code for other developers to use, and there is user code for business logics.</p>

<p>Here we have <code class="highlighter-rouge">library.py</code> from the infra team, <code class="highlighter-rouge">user.py</code> from the user facing team:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># library.py
</span><span class="k">class</span> <span class="nc">Base</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'foo'</span>

<span class="c1"># user.py
</span><span class="kn">from</span> <span class="nn">library</span> <span class="kn">import</span> <span class="n">Base</span>

<span class="k">class</span> <span class="nc">Derived</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">foo</span>
</code></pre></div></div>

<p>Suppose we are on the user facing team and we can’t change the library code. What if the <code class="highlighter-rouge">foo</code> method gets removed? We don’t want our <code class="highlighter-rouge">bar</code> method to break at runtime, we want to catch this before runtime production environment. How to do this easily?</p>

<p>We could add a line above the <code class="highlighter-rouge">Derived</code> class,</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="s">"foo"</span><span class="p">),</span> <span class="s">"You broke it!"</span>
</code></pre></div></div>

<p>This enforces a constraint on the Base class.</p>

<p>Now let’s consider the scenario below where we are in the infra team and are responsible for the library code. We need to make sure the business logic team implement the <code class="highlighter-rouge">bar</code> method.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># library.py
</span><span class="k">class</span> <span class="nc">Base</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>


<span class="c1"># user.py
</span><span class="kn">from</span> <span class="nn">library</span> <span class="kn">import</span> <span class="n">Base</span>

<span class="k">class</span> <span class="nc">Derived</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'bar'</span>
</code></pre></div></div>

<p>We can’t do the same thing as before <code class="highlighter-rouge">assert hasattr(Derived, "bar"), "..."</code>. Try-except also doesn’t work because it only catches the error at runtime, not before.</p>

<p>Python is a “protocol-oriented” language. In C++ and Java, a class definition is not executable code. But in Python it is.</p>

<p>Python has this <code class="highlighter-rouge">__build_class__()</code> method that lets you check things at the time when the class is being built.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">old_bc</span> <span class="o">=</span> <span class="n">__build_class__</span>
<span class="k">def</span> <span class="nf">my_bc</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="n">Base</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Check if bar method defined"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">old_bc</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">old_bc</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">builtins</span>
<span class="n">builtins</span><span class="o">.</span><span class="n">__build_class__</span> <span class="o">=</span> <span class="n">my_bc</span>

<span class="s">"""
Running the code above:

    Check if bar method defined
"""</span>
</code></pre></div></div>

<p>This isn’t typically what we do for the purpose of checking whether the library code is going to break when used in user code. This is just to show that in Python we can hook into the processes of building classes, defining functions, importing modules, and do what we want.</p>

<p>This pattern exists but we don’t use it for this purpose, people use 2 fundamental features of Python to solve this problem of enforcing constraints.</p>

<p>The first one is Metaclass.</p>

<h2 id="metaclass-solution">
<a class="anchor" href="#metaclass-solution" aria-hidden="true"><span class="octicon octicon-link"></span></a>Metaclass: solution</h2>

<p>A metaclass is just a class derived from <code class="highlighter-rouge">type</code> class that allows you to intercept derived types.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BaseMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'BaseMeta.__new__'</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
        <span class="c1"># To prevent user class without `bar` method
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="s">'bar'</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">(</span><span class="s">"Bad user class"</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">BaseMeta</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span>
</code></pre></div></div>

<p><strong>Metaclass is way to enforce constraints on the derived classes, e.g. user code, in the base classes, i.e. library code.</strong></p>

<p><em>Checkout <code class="highlighter-rouge">collections.abc</code>’s (<a href="https://docs.python.org/3/library/collections.abc.html">doc</a>) <code class="highlighter-rouge">abc</code> metaclass which has decorators such as <code class="highlighter-rouge">@abstractmethod</code> so we don’t have to write metaclass ourselves!</em></p>

<h2 id="decorators">
<a class="anchor" href="#decorators" aria-hidden="true"><span class="octicon octicon-link"></span></a>Decorators</h2>

<p><em>Again, Python is a “live” language as in that function definitions, class definitions are executable code that gets executed line by line at runtime.</em></p>

<p>The function decorator is a very important pattern in Python to simplify user code. It makes quick function wrappers. Say we want to time a function, we can do:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">timeit</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="o">@</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"elapsed time:"</span><span class="p">,</span> <span class="n">after</span> <span class="o">-</span> <span class="n">before</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>
    <span class="k">return</span> <span class="n">wrapper_func</span>

<span class="o">@</span><span class="n">timeit</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="s">"""
Decorator is merely a syntax, it is equivalent to
"""</span>
<span class="n">add</span> <span class="o">=</span> <span class="n">timeit</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
</code></pre></div></div>
<h3 id="functoolswraps">
<a class="anchor" href="#functoolswraps" aria-hidden="true"><span class="octicon octicon-link"></span></a>functools.wraps</h3>

<p><code class="highlighter-rouge">functools.wraps</code> is simply a way to preserve the name and docstring of the the original function that is being wrapped. Without it, the wrapped function would lose its original metadata.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">logged</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="o">@</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">with_logging</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">" was called"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">with_logging</span>

<span class="o">@</span><span class="n">logged</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
   <span class="s">"""does some math"""</span>
   <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>  <span class="c1"># prints 'f'
</span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>   <span class="c1"># prints 'does some math'
</span></code></pre></div></div>

<p>Note that not all decorators wrap functions, some of them just “register” the name of the input function, for example. In that case we don’t need to use <code class="highlighter-rouge">functools.wraps</code>. <strong>But usually we should use it for decorators</strong>.</p>

<h3 id="decorator-with-parameters-the-partial-trick">
<a class="anchor" href="#decorator-with-parameters-the-partial-trick" aria-hidden="true"><span class="octicon octicon-link"></span></a>Decorator with parameters: the <code class="highlighter-rouge">partial</code> trick</h3>

<p>One way of thinking about decorators with parameters is</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">decorator</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>translates to</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">foo</span> <span class="o">=</span> <span class="n">decorator</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</code></pre></div></div>

<p>So if the decorator had parameters,</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">decorator_with_params</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p>translates to</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">foo</span> <span class="o">=</span> <span class="n">decorator_with_params</span><span class="p">(</span><span class="n">param</span><span class="p">)(</span><span class="n">foo</span><span class="p">)</span>
</code></pre></div></div>

<p>To make this work, we need to write the decorator function as follows,</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">_outer</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="c1"># magic sauce to lift the name and doc of the function
</span>    <span class="o">@</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1">#do stuff here, for eg.
</span>        <span class="k">print</span> <span class="p">(</span><span class="s">"decorator params: </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">inner</span>

<span class="c1"># THIS IS THE KEY TRICK TO TAKE PARAMS INTO DECORATORS
</span><span class="n">real_decorator</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_outer</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">param</span><span class="p">)</span>

<span class="o">@</span><span class="n">real_decorator</span>
<span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div></div>

<p><em>The line <code class="highlighter-rouge">real_decorator = partial(_outer, params=param)</code> is the key trick to take parameters into a decorator function!</em></p>

<h2 id="generators-two-mental-models">
<a class="anchor" href="#generators-two-mental-models" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generators: two mental models</h2>

<p>There are two important mental models for generators.</p>

<h3 id="laziness">
<a class="anchor" href="#laziness" aria-hidden="true"><span class="octicon octicon-link"></span></a>Laziness</h3>

<p>A generator avoids eager execution and gives you the item you want one by one. This lets you avoid waiting for the entire loop to finish and storing all the items in it.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">i</span>
</code></pre></div></div>

<h3 id="sequencing">
<a class="anchor" href="#sequencing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sequencing</h3>

<p>A generator <strong>can enforce sequences in execution</strong>. It enables interleaving of <strong>coroutines</strong>: some library code runs, then some user code, then some library code…</p>

<p>Say we have an API that needs run some methods <strong>in order</strong>.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""
In this scenario, there is no enforcement of order
"""</span>
<span class="k">class</span> <span class="nc">Api</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">run_this_first</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">first</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">run_this_second</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">second</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">run_this_last</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">last</span><span class="p">()</span>

<span class="s">"""
In this scenario, last() will never be run before second(), by
using the generator.
"""</span>
<span class="k">def</span> <span class="nf">api</span><span class="p">():</span>
    <span class="n">first</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">second</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">last</span><span class="p">()</span>
</code></pre></div></div>

<h2 id="context-managers">
<a class="anchor" href="#context-managers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Context managers</h2>

<p>Simply put, a Context Manager makes sure a pair of commands: an initial action and a final action are always executed.</p>

<p>Here’s what a context manager is under the hood.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">ctx</span><span class="p">()</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># &lt;=&gt;
</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">()</span><span class="o">.</span><span class="n">__enter__</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">x</span><span class="o">.</span><span class="n">__exit__</span><span class="p">()</span>
</code></pre></div></div>

<p>What do we need this? For example, when we do something in a database and would like to drop table when we are done:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">connect</span>

<span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="s">'test.db'</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'create table points(x int, y int)'</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(1, 1)'</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(1, 2)'</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(2, 1)'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'select x, y from points'</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'drop table points'</span><span class="p">)</span>
</code></pre></div></div>

<p>We can write our own context manager to achieve this by:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">temptable</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cur</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__enter__'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'create table points(x int, y int)'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__exit__'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'drop table points'</span><span class="p">)</span>

<span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="s">'test.db'</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">temptable</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(1, 1)'</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(1, 2)'</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(2, 1)'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'select x, y from points'</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></div>

<p>This is a bit better, we can enforce running <code class="highlighter-rouge">__enter__</code> before <code class="highlighter-rouge">__exit__</code> by using context manager, i.e. in this case we enforce <code class="highlighter-rouge">create table</code> before <code class="highlighter-rouge">drop table</code>.</p>

<p>Now we notice we have <strong>sequencing</strong> in execution because one must run before another. This reminds us about <strong>generators</strong>.</p>

<p>We can refactor,</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># THIS IS A GENERATOR WITH INPUT `cur`
</span><span class="k">def</span> <span class="nf">temptable</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'create table points(x int, y int)'</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'drop table points'</span><span class="p">)</span>

<span class="c1"># THIS IS A CALLABLE CLASS WITH A GENERATOR INPUT
</span><span class="k">class</span> <span class="nc">Contextmanager</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen</span> <span class="o">=</span> <span class="n">gen</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__enter__'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gen_instance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_instance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'__exit__'</span><span class="p">)</span>
        <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen_instance</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="n">temptable</span> <span class="o">=</span> <span class="n">Contextmanager</span><span class="p">(</span><span class="n">temptable</span><span class="p">)</span>

<span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="s">'test.db'</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">temptable</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(1, 1)'</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(1, 2)'</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(2, 1)'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'select x, y from points'</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></div>

<p>The line <code class="highlighter-rouge">temptable = Contextmanager(temptable)</code> reminds us of <strong>decorators</strong>!</p>

<p>Fortunately, we don’t need to write <code class="highlighter-rouge">Contextmanager</code> class ourselves, there is this library called <code class="highlighter-rouge">contextlib</code> which already provides it.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">connect</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>


<span class="c1"># THIS IS A GENERATOR WITH INPUT `cur`
# @contextmanager TURNS A GENERATOR INTO A CONTEXT MANAGER!
</span><span class="o">@</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">temptable</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'create table points(x int, y int)'</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'drop table points'</span><span class="p">)</span>


<span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="s">'test.db'</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">temptable</span><span class="p">(</span><span class="n">cur</span><span class="p">):</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(1, 1)'</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(1, 2)'</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into points (x, y) values(2, 1)'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'select x, y from points'</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">@contextmanager</code> turns a generator into a context manager! This is a really useful pattern for creating a context manager for a pair of commands.</p>

<p>This last example combined the 3 core features of Python together:</p>
<ul>
  <li>
<strong>decorator</strong>: syntactic sugar for function wrapping</li>
  <li>
<strong>generator</strong>: avoid eagerness, save resources, force sequencing</li>
  <li>
<strong>context manager</strong>: force paired commands</li>
</ul>

<h2 id="summary">
<a class="anchor" href="#summary" aria-hidden="true"><span class="octicon octicon-link"></span></a>Summary</h2>

<p>Python is a language oriented around <em>protocols</em>. There are ways to implement these protocols on any objects using “dunder” methods. If you forget how to use these methods, just google “Python data model”.</p>

<h2 id="reference">
<a class="anchor" href="#reference" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reference</h2>

<ul>
  <li>
<a href="https://www.youtube.com/watch?v=cKPlPJyQrt4">James Powell: So you want to be a Python expert? PyData Seattle 2017</a> (~2hr)</li>
  <li>
<code class="highlighter-rouge">functools.wraps</code>: <a href="https://stackoverflow.com/questions/308999/what-does-functools-wraps-do">https://stackoverflow.com/questions/308999/what-does-functools-wraps-do</a>
</li>
  <li>The <code class="highlighter-rouge">partial</code> trick for decorators with parameters: <a href="https://stackoverflow.com/a/25827070/2280673">https://stackoverflow.com/a/25827070/2280673</a>
</li>
</ul>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="logancyang/blog-learning-automata"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/note/python/2020/06/15/python-metaclasses.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Notes, code and essays by Logan Yang.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/logancyang" title="logancyang"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/logancyang" title="logancyang"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
